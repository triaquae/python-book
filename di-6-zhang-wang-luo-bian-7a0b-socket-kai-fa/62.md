# 本节重点：

* 让学生知道tcp/ip 5层模型中，每一层都是做什么的
* 让学生掌握每一层中必备的知识点

> **本节时长需控制在60分钟内**

### TCP/IP五层模型讲解（2分）

我们将应用层，表示层，会话层并作应用层，从tcp／ip五层协议的角度来阐述每层的由来与功能，搞清楚了每层的主要协议

就理解了整个互联网通信的原理。

首先，用户感知到的只是最上面一层应用层，自上而下每层都依赖于下一层，所以我们从最下一层开始切入，比较好理解

每层都运行特定的协议，越往上越靠近用户，越往下越靠近硬件

### 物理层（2分）

物理层由来：上面提到，孤立的计算机之间要想一起玩，就必须接入internet，言外之意就是计算机之间必须完成组网

![](http://static.zybuluo.com/agocan/n3dmu4wcajuhgxzdix9ticpg/image_1c1phulig10ftmjl914m11l7g37.png)

物理层功能：主要是基于电器特性发送高低电压\(电信号\)，高电压对应数字1，低电压对应数字0

### 数据链路层（5分）

数据链路层由来：单纯的电信号0和1没有任何意义，必须规定电信号多少位一组，每组什么意思

数据链路层的功能：定义了电信号的分组方式

**以太网协议：**

早期的时候各个公司都有自己的分组方式，后来形成了统一的标准，即以太网协议ethernet

ethernet规定

* 一组电信号构成一个数据包，叫做‘帧’
* 每一数据帧分成：报头head和数据data两部分

| head | data |
| :--- | :--- |


head包含：\(固定18个字节\)

* 发送者／源地址，6个字节
* 接收者／目标地址，6个字节
* 数据类型，6个字节

data包含：\(最短46字节，最长1500字节\)

* 数据包的具体内容

head长度＋data长度＝最短64字节，最长1518字节，超过最大限制就分片发送

**mac地址：**

head中包含的源和目标地址由来：ethernet规定接入internet的设备都必须具备网卡，发送端和接收端的地址便是指网卡的地址，即mac地址

mac地址：每块网卡出厂时都被烧制上一个世界唯一的mac地址，长度为48位2进制，通常由12位16进制数表示（前六位是厂商编号，后六位是流水线号）  
![](http://static.zybuluo.com/agocan/x5i4rgscp9rn8drgvcriz550/image_1c1phvbie1089aas488136h1b3t44.png)

**广播：**

有了mac地址，同一网络内的两台主机就可以通信了（一台主机通过arp协议获取另外一台主机的mac地址）

ethernet采用最原始的方式，广播的方式进行通信，即计算机通信基本靠吼

![](http://static.zybuluo.com/agocan/1i4cdk9d8rla9qxojgzmby3e/image_1c1phvkmg1v60tha11sk848jtt4h.png)

### 网络层（40分）

网络层由来：有了ethernet、mac地址、广播的发送方式，世界上的计算机就可以彼此通信了，问题是世界范围的互联网是由

一个个彼此隔离的小的局域网组成的，那么如果所有的通信都采用以太网的广播方式，那么一台机器发送的包全世界都会收到，

这就不仅仅是效率低的问题了，这会是一种灾难

![](http://static.zybuluo.com/agocan/y83sok1x0fk6pw1xp6kporqz/image_1c1phvu001kpnl93o96ee0qpq4u.png)

上图结论：必须找出一种方法来区分哪些计算机属于同一广播域，哪些不是，如果是就采用广播的方式发送，如果不是，

就采用路由的方式（向不同广播域／子网分发数据包），mac地址是无法区分的，它只跟厂商有关

网络层功能：**引入一套新的地址用来区分不同的广播域／子网，这套地址即网络地址**

##### **IP协议：**

* 规定网络地址的协议叫ip协议，它定义的地址称之为ip地址，广泛采用的v4版本即ipv4，它规定网络地址由32位2进制表示
* 范围0.0.0.0-255.255.255.255
* 一个ip地址通常写成四段十进制数，例：172.16.10.1

**子网掩码**

所谓”子网掩码”，就是表示子网络特征的一个参数。它在形式上等同于IP地址，也是一个32位二进制数字，它的网络部分全部为1，主机部分全部为0。比如，IP地址172.16.10.1，如果已知网络部分是前24位，主机部分是后8位，那么子网络掩码就是11111111.11111111.11111111.00000000，写成十进制就是255.255.255.0。

子网掩码是用来标识一个IP地址的哪些位是代表网络位，以及哪些位是代表主机位。子网掩码不能单独存在，它必须结合IP地址一起使用。_**子网掩码只有一个作用，就是将某个IP地址划分成网络地址和主机地址两部分。**_

> 蒙蔽的你肯定想问，我要区分网络位和主机位干鬼用？
>
> 这就像寄信，你给你的南方姑娘寄信，她肉身在厦门，详细地址是厦门鼓浪屿三街27号，那网络位就相当于城市，详细地址就是主机位，网络位帮你定位到城市，主机位帮你找到你的南方姑娘。 路由器通过子网掩码来确定哪些是网络位，哪些是主机位

区分网络位和主机位是为了划分子网，就是把一个大网络分成多个小网络，为什么要分子网呢?

* **广播风暴**：6万台主机在一个网段里，通信基本靠吼，任何一个人要吼一嗓子，6万多个人必须被动听着，一会你的网络就瘫痪啦。
* **地址浪费**：运营商在公网上有很多级联的路由器，有时候2个路由器之间只会用掉几个IP,如果不进行子网划分，那同网段的其它主机也就都不能用了。举例两个级联路由器的接口ip分别为222.34.24.12/24,222.34.24.13/24, 此可承载255个主机的网段只用了2个IP,那其它的就全浪费了，因为不能再分配给别人。

> 划分子网本质上就是借主机位到给网络位，每借一位主机位，这个网段的可分配主机就会越少，比如192.168.1.0/24可用主机255个，借一位变成192.168.1.0/25，那可用主机就从255-128=127个了（从最大的值开始借），再借一位192.168.1.0/26,那可用主机数就变成了255-\(128+64\)=63个啦

**IP地址分类：**

IP地址根据网络ID的不同分为5种类型，A类地址、B类地址、C类地址、D类地址和E类地址。

1. A类IP地址：一个A类IP地址由1字节的网络地址和3字节主机地址组成，网络地址的最高位必须是“0”， 地址范围从1.0.0.0 到126.0.0.0。可用的A类网络有126个，每个网络能容纳1亿多个主机。
2. B类IP地址 ：一个B类IP地址由2个字节的网络地址和2个字节的主机地址组成，网络地址的最高位必须是“10”，地址范围从128.0.0.0到191.255.255.255。可用的B类网络有16382个，每个网络能容纳6万多个主机 。
3. C类IP地址：一个C类IP地址由3字节的网络地址和1字节的主机地址组成，网络地址的最高位必须是“110”。范围从192.0.0.0到223.255.255.255。C类网络可达209万余个，每个网络能容纳254个主机。
4. D类地址用于多点广播（Multicast）： D类IP地址第一个字节以“lll0”开始，它是一个专门保留的地址。它并不指向特定的网络，目前这一类地址被用在多点广播（Multicast）中。多点广播地址用来一次寻址一组计算机，它标识共享同一协议的一组计算机。
5. E类IP地址 以“llll0”开始，为将来使用保留。

> **全零（“0．0．0．0”）地址对应于当前主机。全“1”的IP地址（“255．255．255．255”）是当前子网的广播地址。**
>
> **回环地址\(127.0.0.1\) 又称为本机地址，那它跟0.0.0.0是什么区别呢？那得先了解回环接口**

![](http://static.zybuluo.com/agocan/18lfae1vwcxhj3qls9ph1kdi/image_1c1ph97dm5aca2hvla1t1216v11g.png)

环回接口（loopback）。平时我们用127.0.0.1来尝试自己的机器服务器好使不好使。走的就是这个loopback接口。对于环回接口，有如下三点值得注意:

* 传给环回地址（一般是127.0.0.1）的任何数据均作为IP输入。
* 传给广播地址或多播地址的数据报复制一份传给环回接口，然后送到以太网上。这是 因为广播传送和多播传送的定义包含主机本身。
* 任何传给该主机IP地址的数据均送到环回接口。

##### IP报文

IP协议是TCP/IP协议的核心，所有的TCP，UDP，IMCP，IGCP的数据都以IP数据格式传输，要注意的是，IP不是可靠的协议，这是说，IP协议没有提供一种数据未传达以后的处理机制－－这被认为是上层协议－－TCP或UDP要做的事情。所以这也就出现了TCP是一个可靠的协议，而UDP就没有那么可靠的区别。这是后话，暂且不提。

IP协议头

![](http://static.zybuluo.com/agocan/brxqa4d4bv29yj8c00u2vwdc/image_1c1ph9ilv1rhu16a9mqncse5151t.png)

挨个解释它是教科书的活计，我感兴趣的只是那八位的TTL字段，还记得这个字段是做什么的么？这个字段规定该数据包在穿过多少个路由之后才会被抛弃\(这里就体现出来IP协议包的不可靠性，它不保证数据被送达\)，某个ip数据包每穿过一个路由器，该数据包的TTL数值就会减少1，当该数据包的TTL成为零，它就会被自动抛弃。这个字段的最大值也就是255，也就是说一个协议包也就在路由器里面穿行255次就会被抛弃了，根据系统的不同，这个数字也不一样，一般是32或者是64

##### **ARP协议**

arp协议由来：计算机通信基本靠吼，即广播的方式，所有上层的包到最后都要封装上以太网头，然后通过以太网协议发送，在谈及以太网协议时候，我门了解到

通信是基于mac的广播方式实现，计算机在发包时，获取自身的mac是容易的，如何获取目标主机的mac，就需要通过arp协议

arp协议功能：广播的方式发送数据包，获取目标主机的mac地址

协议工作方式：每台主机ip都是已知的

例如：主机172.16.10.10/24访问172.16.10.11/24

一：首先通过ip地址和子网掩码区分出自己所处的子网

| 场景 | 数据包地址 |
| :--- | :--- |
| 同一子网 | 目标主机mac，目标主机ip |
| 不同子网 | 网关mac，目标主机ip |

二：分析172.16.10.10/24与172.16.10.11/24处于同一网络\(如果不是同一网络，那么下表中目标ip为172.16.10.1,通过arp获取的是网关的mac\)

|  | 源mac | 目标mac | 源ip | 目标ip | 数据部分 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 发送端主机 | 发送端mac | FF:FF:FF:FF:FF:FF | 172.16.10.10/24 | 172.16.10.11/24 | 数据 |

三：这个包会以广播的方式在发送端所处的子网内传输，所有主机接收后拆开包，发现目标ip为自己的，就响应，返回自己的mac

查看本机arp表的命令

```
Alexs-MacBook-Pro:~ alex$ arp -a
? (192.168.0.3) at 0:21:cc:65:52:f0 on en4 ifscope [ethernet]
? (192.168.0.64) at 68:f7:28:d0:4b:21 on en4 ifscope [ethernet]
? (192.168.0.233) at 84:d9:31:3:ae:8b on en4 ifscope [ethernet]
? (192.168.0.254) at 60:da:83:be:c2:5a on en4 ifscope [ethernet]
? (192.168.0.255) at (incomplete) on en4 ifscope [ethernet]
? (224.0.0.251) at 1:0:5e:0:0:fb on en4 ifscope permanent [ethernet]
```

**ICMP**

前面讲到了，IP协议并不是一个可靠的协议，它不保证数据被送达，那么，自然的，保证数据送达的工作应该由其他的模块来完成。其中一个重要的模块就是ICMP\(网络控制报文\)协议。

当传送IP数据包发生错误－－比如主机不可达，路由不可达等等，ICMP协议将会把错误信息封包，然后传送回给主机。给主机一个处理错误的机会.

我们一般主要用ICMP协议检测网络是否通畅，基于ICMP协议的工具主要有ping 和traceroute

_**ping **_

```
Alexs-MacBook-Pro:~ alex$ ping www.baidu.com
PING www.a.shifen.com (111.13.100.91): 56 data bytes
64 bytes from 111.13.100.91: icmp_seq=0 ttl=54 time=6.563 ms
64 bytes from 111.13.100.91: icmp_seq=1 ttl=54 time=6.320 ms
64 bytes from 111.13.100.91: icmp_seq=2 ttl=54 time=6.698 ms
64 bytes from 111.13.100.91: icmp_seq=3 ttl=54 time=6.445 ms
^C
--- www.a.shifen.com ping statistics ---
4 packets transmitted, 4 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 6.320/6.506/6.698/0.140 ms
```

ping这个单词源自声纳定位，而这个程序的作用也确实如此，它利用ICMP协议包来侦测另一个主机是否可达。原理是用类型码为0的ICMP发请 求，受到请求的主机则用类型码为8的ICMP回应。ping程序来计算间隔时间，并计算有多少个包被送达。用户就可以判断网络大致的情况。我们可以看到， ping给出来了传送的时间和TTL的数据。

_**traceroute**_

用来查看从当前主机到某地址一共经过多少跳路由

```
$ traceroute www.baidu.com

traceroute: Warning: www.baidu.com has multiple addresses; using 111.13.100.91
traceroute to www.a.shifen.com (111.13.100.91), 64 hops max, 52 byte packets
 1  192.168.0.254 (192.168.0.254)  0.458 ms  0.274 ms  0.246 ms
 2  122.71.64.1 (122.71.64.1)  2.006 ms  1.788 ms  1.626 ms
 3  * 222.35.254.253 (222.35.254.253)  2.024 ms  2.243 ms
 4  222.35.254.241 (222.35.254.241)  9.333 ms
    61.233.9.50 (61.233.9.50)  4.960 ms
    61.233.9.93 (61.233.9.93)  3.010 ms
 5  61.237.2.202 (61.237.2.202)  3.442 ms  3.497 ms

 ......
```

### 传输层（15分）

传输层的由来：网络层的ip帮我们区分子网，以太网层的mac帮我们找到主机，然后大家使用的都是应用程序，你的电脑上可能同时开启qq，暴风影音，迅雷等多个应用程序，

那么我们通过ip和mac找到了一台特定的主机，如何标识这台主机上的应用程序呢？答案就是端口，端口即应用程序与网卡关联的编号。

传输层功能：建立端口到端口的通信

补充：端口范围0-65535，0-1023为系统占用端口

传输层有两种协议，TCP和UDP,见下图

![](http://static.zybuluo.com/agocan/z2t2fc70jqxtzzu1q18pg0z7/image_1c1phaje51rgg7gi4u1bkj13sh2q.png)

#### tcp协议

可靠传输，TCP数据包没有长度限制，理论上可以无限长，但是为了保证网络的效率，通常TCP数据包的长度不会超过IP数据包的长度，以确保单个TCP数据包不必再分割。

| 以太网头 | ip 头 | tcp头 | 数据 |
| :--- | :--- | :--- | :--- |


> 为什么tcp是可靠的数据传输呢？
>
> **最可靠的方式就是只要不得到确认，就重新发送数据报，直到得到对方的确认为止。**

tcp报文

![](http://static.zybuluo.com/agocan/okd2wkcuyealmxbhjtswt3t6/image_1c1pi13rojvpu5f1iph75fp8o5b.png)

tcp的3次握手和4四挥手

!\[image\_1c1phb5ao10jb183v1l3i1psgo6037.png-281.7kB\]\[17\]

#### udp协议

不可靠传输，”报头”部分一共只有8个字节，总长度不超过65,535字节，正好放进一个IP数据包。

| 以太网头 | ip头 | udp头 | 数据 |
| :--- | :--- | :--- | :--- |


总结

TCP协议虽然安全性很高，但是网络开销大，而UDP协议虽然没有提供安全机制，但是网络开销小，在现在这个网络安全已经相对较高的情况下，为了保证传输的速率，我们一般还是会优先考虑UDP协议！

\[17\]: [http://static.zybuluo.com/agocan/gbg90sa2fn94tkk3asobet6u/image\_1c1phb5ao10jb183v1l3i1psgo6037.png](http://static.zybuluo.com/agocan/gbg90sa2fn94tkk3asobet6u/image_1c1phb5ao10jb183v1l3i1psgo6037.png)

